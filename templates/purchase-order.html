{% extends "base-template.html" %}
{% block title %}Purchase Order{% endblock %}

{% block body %}

<div id="app" v-cloak>
    <!-- NAVIGATION BAR -->
    <navbar-gas active="nav-purchase" photo="/media/{{request.user.image}}"></navbar-gas>
    <app-card></app-card>
    <profile-card first_name="{{request.user.first_name}}" last_name="{{request.user.last_name}}" position="{{request.user.position}}" auth_level="{{request.user.authLevel}}" photo="/media/{{request.user.image}}/"></profile-card>

    <!-- MAIN BODY -->
    <div class="container">
        <!-- MORE NAVIGATION -->
        <div class="d-flex font-semibold mb-2 justify-content-center">
            <div class="justify-content-center c-nav-links gas-nav">
                <a href="/purchase-order/" class="active-gas mx-2">Create</a>
                <a href="/purchase-order-list/" class="mx-2">PO List</a>
            </div>
        </div> 
        <!-- TITLE AND BUTTONS -->
        <div class="d-flex align-items-center mb-3">
            <span class="font-size-18 font-bold mr-1">Purchase Order</span>
        </div>
        <!-- PURCHASE -->
        <div>
            <!-- REFERENCE NO AND DATES -->
            <div class="row">
                <div class="col col-3 pr-2">
                    <label>Reference No.</label>
                    <input v-model="purchaseOrder.code" type="text" class="form-control" name="code" placeholder="Enter Reference No."a>
                </div>
                <div class="col col-2 px-2">
                    <label>Date</label>
                    <input v-model="purchaseOrder.date" type="date" class="form-control" name="date">
                </div>
                <div class="col col-2 pl-2">
                    <label><span>Retroactive</span>&nbsp;<span class="font-size-10 gray">(optional)</span></label>
                    <input v-model="purchaseOrder.retroactive" type="date" class="form-control" name="retroactiveDate">
                </div>
            </div>
            <!-- VENDOR -->
            <div class="row mt-2 mb-4">
                <div class="col col-5 pr-2">
                    <label>Vendor</label>
                    <select v-model="purchaseOrder.vendor" name="vendor" class="form-control">
                        <option value="" selected disabled>Choose Vendor</option>
                        <option v-for="v in vendor" :value="v.id">[[v.name]]</option>
                    </select>
                </div>
                <div class="col col-2 pl-2">
                    <label>Purchase Request</label>
                    <select name="pr" class="form-control">
                        <option value="-1" selected disabled>Choose Request</option>
                        <option value="">None</option>
                    </select>
                </div>
            </div>

            <!-- PURCHASE ITEMS AND DETAILS -->
            <div class="container-extend px-5 py-4 b-tr-radius-15 b-tl-radius-15 order-card mt-3">
                <div class="row">
                    <div class="col px-1">
                        <label for="code" class="m-0">Inventory</label>
                    </div>
                    <div class="col-3 px-1">
                        <label for="warehouse" class="m-0">Item-Code - Item name</label>
                    </div>
                    <div class="col-1 px-1">
                        <label for="remaining" class="m-0">Remaining</label>
                    </div>
                    <div class="col-1 px-1">
                        <label for="order-quantity" class="m-0">Order Qty</label>
                    </div>
                    <div class="col-2 px-1">
                        <label for="order-quantity" class="m-0">Purchasing Price <span class="font-size-10 gray">per qty</span></label>
                    </div>
                    <div class="col-2 px-1">
                        <label for="cost-per-item" class="m-0">Input VAT</label>
                    </div>
                    <div class="col-2 px-1">
                        <label for="Total Cost" class="m-0">Total Cost</label>
                    </div>
                    <i class="fas fa-minus-circle stop" style="color:rgba(0,0,0,0)"></i>
                </div>
                <!-- V-FOR ITEMS -->
                <div class="row" v-for="(item, index) in purchaseOrder.items">
                    <div class="col px-1">
                        <select v-model="item.type" class="form-control">
                            <option value="" selected disabled>Choose Type</option>
                            <option v-for="type in inventoryTypes" :value="type">[[type]]</option>
                        </select>
                    </div>
                    <div class="col-3 px-1">
                        <!-- V-IF ELSE FOR DIFFERENT INVENTORY LIST -->
                        <select @change="getMerchRemaining(item.code, index)" v-model="item.code" class="form-control" v-if="item.type == 'Merchandise'">
                            <option value="" selected disabled>Choose Merchandise Inventory</option>
                            <option v-for="item in merchandiseInventory" :value="item.id">[[item.code]] - [[item.classification]] [[item.type]]</option>
                        </select>
                        <select v-model="item.code" class="form-control" v-else></select>
                        <!-- END -->
                    </div>
                    <div class="col-1 px-1">
                        <input v-model="item.remaining" type="number" class="form-control" readonly>
                    </div>
                    <div class="col-1 px-1">
                        <input v-model="item.quantity" @change="onForTotalCost(index)" type="number" class="form-control" min="0">
                    </div>
                    <div class="col-2 px-1">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">₱</span>
                            </div>
                            <input v-model="item.vatable" @change="onForTotalCost(index)" type="number" step="0.01" class="form-control box-shadow-off" min="0">
                        </div>
                    </div>
                    <div class="col-2 px-1">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">%</span>
                            </div>
                            <input v-model="item.inputVAT" type="number" @change="onForTotalCost(index)" step="0.01" class="form-control box-shadow-off" min="0">
                        </div>
                    </div>
                    <div class="col-2 pl-1">
                        <input type="text" :value="formatPrice(item.totalCost)" class="form-control" readonly>
                    </div>
                    <i @click="remove(index)" class="fas fa-minus-circle stop text-shadow-small" style="line-height: 30px;"></i>
                </div>
                <!-- ADD NEW LINE -->
                <div class="row">
                    <div class="col px-1">
                        <button @click="addLine()" class="btn btn-warning my-1" type="button">+ Add New Line</button>
                    </div>
                </div>

                <!-- ATC AND AMOUNT -->
                <div class="row mt-2">
                    <!-- ATC AND MORE -->
                    <div class="col-6 pl-0">
                        <div class="p-4 order-card-darker b-radius-15">
                            <div class="row" v-for="(line, index) in purchaseOrder.atc">
                                <div class="col-3 px-1">
                                    <label>ATC Code</label>
                                    <select v-model="line.code" class="form-control">
                                        
                                    </select>
                                </div>
                                <div class="col-3 px-1">
                                    <label>Amount</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">₱</span>
                                        </div>
                                        <input v-model="line.amount" type="number" step="0.02" class="form-control box-shadow-off">
                                    </div>
                                </div>
                                <div class="col-3 px-1">
                                    <label>Tax Rate</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <input v-model="line.taxRate" type="number" step="0.02" class="form-control box-shadow-off" readonly>
                                    </div>
                                </div>
                                <div class="col-3 px-1">
                                    <label>Amount Withheld</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">₱</span>
                                        </div>
                                        <input v-model="line.amountWithheld" type="number" step="0.02" class="form-control box-shadow-off" readonly>
                                    </div>
                                </div>
                            </div>
                            <!-- REMARKS -->
                            <div class="row">
                                <div class="col-12 px-1">
                                    <label>Remarks</label>
                                    <textarea v-model="purchaseOrder.remarks" cols="30" rows="2" class="form-control" placeholder="Enter Remarks (Optional)"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- AMOUNT AND PAYMENT -->
                    <div class="col-6 pr-0">
                        <div class="p-4 order-card-darker b-radius-15">
                            <div class="row">
                                <div class="col-6 px-1">
                                    <label>Amount Due</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">₱</span>
                                        </div>
                                        <input type="text" :value="formatPrice(purchaseOrder.amountDue)" class="form-control box-shadow-off" readonly>
                                    </div>
                                </div>
                                <div class="col-6 px-1">
                                    <label>Amount Paid</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">₱</span>
                                        </div>
                                        <input v-model="purchaseOrder.amountPaid" type="number" step="0.01" class="form-control box-shadow-off" min="0" :max="purchaseOrder.amountDue">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 px-1">
                                    <label>Payment Method</label>
                                </div>
                                <div class="col-12 px-1">
                                    <div class="d-flex align-items-center">
                                        <select v-model="purchaseOrder.paymentMethod" class="col col-5 form-control">
                                            <option value="" selected disabled>Choose Payment Method</option>
                                            <option value="Cash on Hand">Cash on Hand</option>
                                            <option value="Cash in Bank">Cash in Bank</option>
                                            <option value="Cheque">Cheque</option>
                                            <option value="Other">Other</option>
                                        </select>
                                        <div class="col ml-2 form-check form-check-inline">
                                            <input v-model="purchaseOrder.paymentPeriod" value="Full Payment" name="radios" type="radio" class="form-check-input">
                                            <label class="form-check-label">Full Payment</label>
                                        </div>
                                        <div class="col form-check form-check-inline">
                                            <input v-model="purchaseOrder.paymentPeriod" value="Partial Payment" name="radios" type="radio" class="form-check-input">
                                            <label class="form-check-label">Partial Payment</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6 px-1">
                                    <label>Cheque No.</label>
                                    <input v-model="purchaseOrder.chequeNo" type="text" class="form-control" placeholder="Leave blank if applicable">
                                </div>
                                <div class="col-6 px-1">
                                    <label>Due Date</label>
                                    <input v-model="purchaseOrder.dueDate" type="date" class="form-control">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 px-1">
                                    <label>Bank</label>
                                    <input v-model="purchaseOrder.bank" type="text" class="form-control" placeholder="Leave blank if applicable">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div @click="checkForm()" class="container-extend border container-extend btn-bottom">
                Save
            </div>
        </div>
    </div>
    <pre>[[ $data ]]</pre>
</div>

{% endblock %}

{% block scripts %}

<script>
    var app = new Vue({
        delimiters: ['[[', ']]'],
        el: "#app",

        data:{
            config:{
                headers: {
                    "X-CSRFToken": getCookie('csrftoken')
                }
            },
            inventoryTypes: [
                'Merchandise',
                'Manufacturing'
            ],
            purchaseOrder:{
                code: '{{new_code}}',
                date: new Date().toISOString().split('T')[0],
                dateTimeCreated: new Date().toISOString(),
                retroactive: null,
                vendor: '',
                items: [{
                    type: '',
                    code: '',
                    remaining: null,
                    quantity: null,
                    vatable: 0.00,
                    inputVAT: 0,
                    totalCost: null
                }],
                atc: [{
                    code: null,
                    amount: null,
                    taxRate: null,
                    amountWithheld: null,
                }],

                remarks: null,
                amountDue: '0',
                amountPaid: null,
                paymentMethod: '',
                paymentPeriod: null,
                chequeNo: null,
                dueDate: null,
                bank: null,
            },
            vendor: [],
            merchandiseInventory: [],
            errors: []

        },
        computed: {
            amountDue(){
                return this.purchaseOrder.items.map(item=>item.totalCost)
            },

            amountPaid(){
                return Number(this.purchaseOrder.amountPaid)
            },
            amountDue2(){
                return Number(this.purchaseOrder.amountDue)
            }
        },

        watch: {
            amountDue(){
                this.purchaseOrder.amountDue = (this.amountDue.reduce((a, b)=>Number(a)+Number(b), 0)).toFixed(5)
            },

            amountDue2(){
                if (this.amountPaid == this.amountDue2){
                    this.purchaseOrder.paymentPeriod = 'Full Payment'
                } else {
                    this.purchaseOrder.paymentPeriod = 'Partial Payment'
                }
            },

            amountPaid(){
                if (this.amountPaid == this.amountDue2){
                    this.purchaseOrder.paymentPeriod = 'Full Payment'
                } else {
                    this.purchaseOrder.paymentPeriod = 'Partial Payment'
                }
            }
        },

        methods:{

            loadData(){
                axios.get('/api/vendor/')
                .then(res=>this.vendor=res.data)
                .catch(err=>{
                    Swal.fire({
                        title: "Something went wrong.",
                        html: err,
                        icon: 'error'
                    })
                })

                axios.get('/api/merchinventory/')
                .then(res=>this.merchandiseInventory=res.data)
                .catch(err=>{
                    Swal.fire({
                        title: "Something went wrong.",
                        html: err,
                        icon: 'error'
                    })
                })
            },

            checkForm(e){
                if (
                    this.purchaseOrder.code &&
                    this.purchaseOrder.date &&
                    this.purchaseOrder.vendor &&
                    this.purchaseOrder.amountPaid &&
                    this.purchaseOrder.paymentMethod &&
                    this.purchaseOrder.paymentPeriod 
                    ){

                    this.submit()
                    return false
                }
                this.errors = []
                if (!this.purchaseOrder.code){
                    this.errors.push('Code Required')
                }
                if (!this.purchaseOrder.date){
                    this.errors.push('Date Required')
                }
                if (!this.purchaseOrder.vendor){
                    this.errors.push('Vendor Required')
                }
                if (!this.purchaseOrder.amountPaid){
                    this.errors.push('Amount Paid Required')
                }
                if (!this.purchaseOrder.paymentMethod){
                    this.errors.push("Payment Method Required")
                }
                if (!this.purchaseOrder.paymentPeriod){
                    this.errors.push('Payment Period Required')
                }

                Swal.fire({
                    title: "Unfilled Inputs",
                    html: this.errors.join('<br>'),
                    icon: 'warning'
                })
            },
            
            formatPrice(val){
                val = Number(val).toFixed(2)
                var num = val.replace(/,/gi, "");
                var num1 = num.split('.')
                var num2 = num1[0].split(/(?=(?:\d{3})+$)/).join(",");
                val = (num1[1] === undefined ? num2 : num2 + "." + num1[1])
                return val
            },

            purchaseOrderInitial(){
                return{
                    code: '{{new_code}}',
                    date: new Date().toISOString().split('T')[0],
                    dateTimeCreated: new Date().toISOString(),
                    retroactive: null,
                    vendor: '',
                    items: [{
                        type: '',
                        code: '',
                        remaining: null,
                        quantity: null,
                        vatable: 0.00,
                        inputVAT: 0,
                        totalCost: null
                    }],
                    atc: [{
                        code: null,
                        amount: null,
                        taxRate: null,
                        amountWithheld: null,
                    }],
                
                    remarks: null,
                    amountDue: '0',
                    amountPaid: null,
                    paymentMethod: '',
                    paymentPeriod: null,
                    chequeNo: null,
                    dueDate: null,
                    bank: null,
                    }
            },

            addLine(){
                this.purchaseOrder.items.push({
                    type: '',
                    code: '',
                    remaining: null,
                    quantity: null,
                    vatable: 0.00,
                    inputVAT: 0,
                    totalCost: null
                })
            },

            getMerchRemaining(id, index){
                item = this.merchandiseInventory.find(x=>x.id==id)
                this.purchaseOrder.items[index].remaining = item.qtyA
            },

            onForTotalCost(index){
                row = this.purchaseOrder.items[index]
                row.totalCost = Number((row.vatable * row.quantity * (1+(row.inputVAT/100)).toFixed(4))).toFixed(4)
            },

            remove (index) {
                this.$delete(this.purchaseOrder.items, index)
            },
            submit(){
                if(this.purchaseOrder.amountDue >= this.purchaseOrder.amountPaid){
                    axios.post('/save-purchase-order/', this.purchaseOrder, this.config)
                    .then(res=>res.data==0?location.reload():'')
                } else {
                    Swal.fire({
                        title: 'Something went wrong',
                        html: "Amount Paid should be less than or equal to Amount Due.",
                        icon: 'warning'
                    })
                }
                
            }
        },
        mounted(){
            this.loadData()
        }
    })
</script>

{% endblock %}