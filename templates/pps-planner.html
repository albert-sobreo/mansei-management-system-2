{% extends "base-template.html" %}
{% block title %}Project Planner{% endblock %}

{% block header_links %}
<link rel="stylesheet" href="/static/css/scrollbars.css">
{% endblock %}

{% block body %}

<div id="app" v-cloak>
    <!-- NAV BAR -->
    <navbar-pps active="nav-planner" photo="/media/{{request.user.image}}"></navbar-pps>
    <app-card></app-card>
    <profile-card branch="{{request.user.branch.name}}" first_name="{{request.user.first_name}}" last_name="{{request.user.last_name}}" position="{{request.user.position}}" auth_level="{{request.user.authLevel}}" photo="/media/{{request.user.image}}/"></profile-card>

    <!-- TITLE BODY -->
    <div class="container">
        <!-- TITLE -->
        <div class="d-flex align-items-center mb-3">
            <span class="font-size-18 font-bold mr-1">Project Planner</span>
        </div>
    </div>
    
    <!-- MAIN BODY -->
    <div class="container-fluid d-flex flex-row px-5">
        <div id="pps-left-side d-flex flex-column">
            <!-- DETAILS -->
            <div v-if="projectPlan.id" :style="`background:linear-gradient(` + projectPlan.accentColor + `, white); padding-top: 3px`" class="w-250px pps-container-1 b-radius-15 box-shadow-medium d-flex flex-column">
                <div class="py-2 px-3 b-radius-15" style="background-color: white">
                    <div class="d-flex flex-row align-items-center mb-2">
                        <span class="font-bold font-size-18">Details</span>
                    </div>

                    <div class="d-flex flex-column mb-3">
                        <div class="d-flex flex-row justify-content-between align-items-center">
                            <span class="font-semibold gray">Department</span>

                            <span @click="initEditDepartment(projectPlan.department)" data-toggle="modal" data-target="#editDepartmentModal" class="gray font-size-8 link" title="Edit Department"><i class="fas fa-pen"></i></span>
                        </div>
                        <div>
                            <span class="font-bold font-size-14">[[getSelectedDepartment(projectPlan.department)]]</span>
                        </div>
                    </div>

                    <div class="d-flex flex-column mb-3">
                        <div class="d-flex flex-row justify-content-between align-items-center">
                            <span class="font-semibold gray">Project</span>
                            
                            <span @click="initEditProject()" data-toggle="modal" data-target="#editProjectModal" class="gray font-size-8 link" title="Edit Project"><i class="fas fa-pen"></i></span>
                        </div>
                        <div>
                            <span class="font-bold font-size-14">[[projectPlan.name]]</span>
                        </div>
                    </div>

                    <div class="d-flex flex-column mb-3">
                        <div>
                            <span class="font-semibold gray">Project Period</span>
                        </div>
                        <div>
                            <span class="font-bold font-size-14" v-if="projectPlan.name">[[formatDate2(projectPlan.dateStart)]] - [[formatDate1(projectPlan.dateEnd)]]</span>
                        </div>
                    </div>

                    <div class="d-flex flex-column mb-3">
                        <div>
                            <span class="font-semibold gray">Project Leader</span>
                        </div>
                        <div>
                            <span class="font-bold font-size-14">[[projectPlan.projectLeader.first_name]] [[projectPlan.projectLeader.last_name]]</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DEPARTMENT PROJECT SELECT -->
            <div class=" mt-3 py-2 px-3 w-250px pps-container-1 b-radius-15 box-shadow-medium border d-flex flex-column">
                <div id="department" class="d-flex flex-column mb-3">
                    <div id="dep-title-button" class="d-flex justify-content-between">
                        <span class="font-bold font-size-18">Department</span>
                        <button data-toggle="modal" data-target="#addDepartmentModal" title="Add Department" class="btn btn-warning b-radius-circle p-0 d-flex align-items-center justify-content-center text-center" style="width: 24px;"><span class="font-size-14">+</span></button>
                    </div>
                    <div id="dept-select" class="row">
                        <div class="col">
                            <select @change="fetchProjectSelect()" v-model="selectedDepartment" name="" id="" class="form-control">
                                <option value="" selected disabled>Select Department</option>
                                <option v-for="d in departmentSelect" :value="d.id">[[d.name]]</option>
                            </select>
                        </div>
                    </div>
                </div>
    
                <div id="project" class="d-flex flex-column">
                    <div id="proj-title-button" class="d-flex justify-content-between">
                        <span class="font-bold font-size-18">Projects</span>
                        <button data-toggle="modal" data-target="#addProjectModal" title="Add Projects" class="btn btn-warning b-radius-circle p-0 d-flex align-items-center justify-content-center text-center" style="width: 24px;"><span class="font-size-14">+</span></button>
                    </div>
                    <div id="proj-select" class="row mt-1">
                        <div v-if="projectSelect" class="col-12 mb-2" v-for="p in projectSelect" :onmouseover="'this.style.color=`' + p.accentColor + '`'" onmouseleave="this.style.color=`#000000`" @click="fetchProjectPlan(p.id)">
                            <div class="b-radius-5 box-shadow-medium project-button" :style="'background:linear-gradient(' + p.accentColor + ', white); padding-top: 2px'">
                                <div class="b-radius-5 py-1 px-3" style="background-color: white;">
                                    <span class="font-semibold">[[p.name]]</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="pps-right-side" class="ml-5 overflow-auto" style="max-width:100%">
            <div id="stages-container" class="d-flex flex-nowrap ml-3">
                <div class=""  v-for="stage in projectPlan.projectstage" v-if="projectPlan.name">
                    <div :style="`background:linear-gradient(` + stage.accentColor + `, white); padding-top: 3px`" class="mr-4 mb-4 w-250px pps-container-2 b-radius-15 b-radius-15 box-shadow-medium d-flex flex-column">
                        <div class="py-2 px-3 b-radius-15 d-flex flex-column" style="background-color: white;">
                            <div class="stage-top-container d-flex justify-content-between">
                                <div class="stage-title d-flex align-items-center justify-content-center">
                                    <div>
                                        <span class="font-bold font-size-14">[[stage.name]]</span>
                                    </div>
                                    &nbsp;
                                    <div @click="initEditStage(stage.id)" data-toggle="modal" data-target="#editStageModal">
                                        <span class="gray font-size-8 link"><i class="fas fa-pen"></i></span>
                                    </div>
                                </div>
                                
                                <div @click="initAddTask(stage.id)" data-toggle="modal" data-target="#addTaskModal" class="stage-new-task">
                                    <span class="gray link">+ New Task</span>
                                </div>
                            </div>

                            <div class="task-container b-radius-10 box-shadow-small p-2 my-2" v-for="task in stage.projecttask">
                                <div class="stage-mid-0-container d-flex justify-content-between">
                                    <div>
                                        <span class="gray font-size-12" :title="`Period: ` + formatDateTime2(task.datetimeStart) + ' to ' + formatDateTime2(task.datetimeEnd)"><i class="far fa-calendar-alt"></i></span>
                                    </div>
                                    <div @click="initEditTask(stage.id, task.id)" class="task-edit" data-toggle="modal" data-target="#editTaskModal">
                                        <span class="gray font-size-8 link"><i class="fas fa-pen"></i></span>
                                    </div>
                                </div>
                                <div class="stage-mid-1-container d-flex">
                                    <div class="task-title">
                                        <span class="font-semibold">[[task.name]]</span>
                                    </div>
                                </div>
    
                                <div class="stage-mid-2-container d-flex">
                                    <div class="task-note">
                                        <span>[[task.notes]]</span>
                                    </div>
                                </div>
    
                                <div class="stage-mid-3-container d-flex flex-column mt-2">
                                    <a :href="`#assigneeCollapse` + task.id" data-toggle="collapse"><span class="gray font-semibold">Assignees <i class="fas fa-caret-right"></i></span></a>
                                    <div class="collapse" :id="`assigneeCollapse` + task.id">
                                        <div class="assignee-container d-flex flex-column">
                                            <div class="assignee mt-1 d-flex align-items-center" v-for="assignee in task.projectassignee">
                                                <div class="assignee-profile-pic mr-2">
                                                    <img :src="assignee.user.image" class="assignee-profile-pic b-radius-circle border" alt="" style="object-fit: cover;">
                                                </div>
                                                <div class="assignee-name">
                                                    <span class="font-semibold">[[assignee.user.first_name]] [[assignee.user.last_name]]</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
    
                                <div class="stage-mid-3-container d-flex flex-column mt-2">
                                    <a :href="`#actionCollapse` + task.id" data-toggle="collapse"><span class="gray font-semibold">Actions <i class="fas fa-caret-right"></i></span></a>
                                    <div class="collapse" :id="'actionCollapse' + task.id">
                                        <div>
                                            <label for="">Move Task to:</label>
                                            <select v-model="task.movetostage" name="" id="" class="form-control">
                                                <option value="" disabled selected>Select Stage</option>
                                                <option v-for="stage in projectPlan.projectstage" :value="stage.id">[[stage.name]]</option>
                                            </select>
                                            <button class="btn btn-primary" @click="moveTaskToStage(task.id, task.movetostage)">Move</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="projectPlan.id">
                    <div @click="initAddStage()" data-toggle="modal" data-target="#addStageModal" class="mr-4 mb-4 py-2 px-3 w-250px pps-container-1 b-radius-15 d-flex flex-column justify-content-center align-items-center add-new-stage">
                        <span class="font-bold font-size-16">+ New Stage</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADD DEPARTMENT MODAL -->
        <div class="modal fade" id="addDepartmentModal">
            <div class="modal-dialog modal-sm">
                <div class="modal-content b-radius-15">
                    <div class="modal-body">
                        <div class="mb-4">
                            <span class="modal-title">Add Department</span>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Name</label>
                                <input v-model="addDepartment.name" type="text" class="form-control" placeholder="Enter Department Name">
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col">
                                <button @click="submitAddDepartment()" class="btn btn-primary col">Add Department</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADD PROJECT MODAL -->
        <div class="modal fade" id="addProjectModal">
            <div class="modal-dialog">
                <div class="modal-content b-radius-15">
                    <div class="modal-body">
                        <div class="mb-4">
                            <span class="modal-title">Add Project</span>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Name</label>
                                <input v-model="addProject.name" type="text" class="form-control" placeholder="Enter Project Name">
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col pr-1">
                                <label for="">Date Start</label>
                                <input v-model="addProject.dateStart" type="date" class="form-control">
                            </div>
                            <div class="col pl-1">
                                <label for="">Date End</label>
                                <input v-model="addProject.dateEnd" type="date" class="form-control">
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Project Leader</label>
                                <select v-model="addProject.projectLeader" name="" id="" class="form-control">
                                    <option value="" selected disabled>Select Project Leader</option>
                                    <option v-for="a in assigneeSelect" :value="a.id">[[a.first_name]] [[a.last_name]]</option>
                                </select>
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Department</label>
                                <select v-model="addProject.department" name="" id="" class="form-control">
                                    <option value="" selected disabled>Select Department</option>
                                    <option v-for="d in departmentSelect" :value="d.id">[[d.name]]</option>
                                </select>
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Accent Color</label>
                                <input v-model="addProject.accentColor" type="color" class="form-control form-control-color" value="#aeaeae">
                            </div>
                        </div>

                        <div class="row mt-5">
                            <div class="col">
                                <button @click="submitAddProject()" class="btn btn-primary col">Add Project</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADD STAGE MODAL -->
        <div class="modal fade" id="addStageModal">
            <div class="modal-dialog">
                <div class="modal-content b-radius-15">
                    <div class="modal-body">
                        <div class="mb-4">
                            <span class="modal-title">Add Stage</span>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Name</label>
                                <input v-model="addStage.name" type="text" class="form-control" placeholder="Enter Stage Name">
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Accent Color</label>
                                <input v-model="addStage.accentColor" type="color" class="form-control form-control-color" value="#aeaeae">
                            </div>
                        </div>

                        <div class="row mt-5">
                            <div class="col">
                                <button @click="submitAddStage" class="btn btn-primary col">Add Stage</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADD TASK MODAL -->
        <div class="modal fade" id="addTaskModal">
            <div class="modal-dialog">
                <div class="modal-content b-radius-15">
                    <div class="modal-body">
                        <div class="mb-4">
                            <span class="modal-title">Add Task</span>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Name</label>
                                <input v-model="addTask.name" type="text" class="form-control" placeholder="Enter Task Name">
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col-6 pr-1">
                                <label for="">Datetime Start</label>
                                <input v-model="addTask.datetimeStart" type="datetime-local" class="form-control">
                            </div>
                            <div class="col-6 pl-1">
                                <label for="">Datetime End</label>
                                <input v-model="addTask.datetimeEnd" type="datetime-local" class="form-control">
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Notes/Description</label>
                                <textarea v-model="addTask.notes" name="" id="" cols="30" rows="5" class="form-control" placeholder="Enter Notes or Description"></textarea>
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Assignees</label>
                                <div class="row">
                                    <div class="col-12">
                                        <select v-for="(item,index) in addTask.assignees" v-model="item.id" name="" id="" class="form-control">
                                            <option value="" selected disabled>Select an Assignee</option>
                                            <option v-for="a in assigneeSelect" :value="a.id">[[a.first_name]] [[a.last_name]]</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row mt-1">
                                    <div class="col">
                                        <button @click="pushTask()" class="btn btn-warning">+ Add</button>
                                        <button @click="popTask()" class="btn btn-danger">- Remove</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-5">
                            <div class="col">
                                <button @click="submitAddTask()" class="btn btn-primary col">Add Task</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EDIT STAGE MODAL -->
        <div class="modal fade" id="editStageModal">
            <div class="modal-dialog">
                <div class="modal-content b-radius-15">
                    <div class="modal-body">
                        <div class="mb-4">
                            <span class="modal-title">Edit Stage</span>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Name</label>
                                <input v-model="editStage.name" type="text" class="form-control" placeholder="Enter Stage Name">
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Accent Color</label>
                                <input v-model="editStage.accentColor" type="color" class="form-control form-control-color" value="#aeaeae">
                            </div>
                        </div>

                        <div class="row mt-5">
                            <div class="col pr-1">
                                <button @click="submitEditStage()" class="btn btn-primary col">Save Changes</button>
                            </div>
                            <div class="col pl-1">
                                <button @click="deleteEditStage()" class="btn btn-danger col">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EDIT TASK MODAL -->
        <div class="modal fade" id="editTaskModal">
            <div class="modal-dialog">
                <div class="modal-content b-radius-15">
                    <div class="modal-body">
                        <div class="mb-4">
                            <span class="modal-title">Edit Task</span>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Name</label>
                                <input v-model="editTask.name" type="text" class="form-control" placeholder="Enter Task Name">
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col-6 pr-1">
                                <label for="">Datetime Start</label>
                                <input v-model="editTask.datetimeStart" type="datetime-local" class="form-control">
                            </div>
                            <div class="col-6 pl-1">
                                <label for="">Datetime End</label>
                                <input v-model="editTask.datetimeEnd" type="datetime-local" class="form-control">
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Notes/Description</label>
                                <textarea v-model="editTask.notes" name="" id="" cols="30" rows="5" class="form-control" placeholder="Enter Notes or Description"></textarea>
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Assignees</label>
                                <div class="row">
                                    <div class="col-12">
                                        <select v-for="(item,index) in editTask.assignees" v-model="item.id" class="form-control">
                                            <option value="" selected disabled>Select an Assignee</option>
                                            <option v-for="a in assigneeSelect" :value="a.id">[[a.first_name]] [[a.last_name]]</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row mt-1">
                                    <div class="col">
                                        <button @click="pushEditTask()" class="btn btn-warning">+ Add</button>
                                        <button @click="popEditTask()" class="btn btn-danger">- Remove</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-5">
                            <div class="col pr-1">
                                <button @click="submitEditTask()" class="btn btn-primary col">Save Changes</button>
                            </div>
                            <div class="col pl-1">
                                <button @click="deleteEditTask()" class="btn btn-danger col">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EDIT DEPARTMENT MODAL -->
        <div class="modal fade" id="editDepartmentModal">
            <div class="modal-dialog modal-sm">
                <div class="modal-content b-radius-15">
                    <div class="modal-body">
                        <div class="mb-4">
                            <span class="modal-title">Edit Department</span>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Name</label>
                                <input v-model="editDepartment.name" type="text" class="form-control" placeholder="Enter Department Name">
                            </div>
                        </div>

                        <div class="row mt-5">
                            <div class="col pr-1">
                                <button @click="submitEditDepartment()" class="btn btn-primary col">Save Changes</button>
                            </div>
                            <div class="col pl-1">
                                <button class="btn btn-danger col">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EDIT PROJECT MODAL -->
        <div class="modal fade" id="editProjectModal">
            <div class="modal-dialog">
                <div class="modal-content b-radius-15">
                    <div class="modal-body">
                        <div class="mb-4">
                            <span class="modal-title">Edit Project</span>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Name</label>
                                <input v-model="editProject.name" type="text" class="form-control" placeholder="Enter Project Name">
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col pr-1">
                                <label for="">Date Start</label>
                                <input v-model="editProject.dateStart" type="date" class="form-control">
                            </div>
                            <div class="col pl-1">
                                <label for="">Date End</label>
                                <input v-model="editProject.dateEnd" type="date" class="form-control">
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Project Leader</label>
                                <select v-model="editProject.projectLeader" name="" id="" class="form-control">
                                    <option value="" selected disabled>Select Project Leader</option>
                                    <option v-for="a in assigneeSelect" :value="a.id">[[a.first_name]] [[a.last_name]]</option>
                                </select>
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Department</label>
                                <select v-model="editProject.department" name="" id="" class="form-control">
                                    <option value="" selected disabled>Select Department</option>
                                    <option v-for="d in departmentSelect" :value="d.id">[[d.name]]</option>
                                </select>
                            </div>
                        </div>

                        <div class="row my-2">
                            <div class="col">
                                <label for="">Accent Color</label>
                                <input v-model="editProject.accentColor" type="color" class="form-control form-control-color" value="#aeaeae">
                            </div>
                        </div>

                        <div class="row mt-2">
                            <div class="col pr-1">
                                <button @click="submitEditProject()" class="btn btn-primary col">Save Changes</button>
                            </div>
                            <div class="col pl-1">
                                <button @click="deleteEditProject()" class="btn btn-danger col">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}

<script>
    var app = new Vue({
        delimiters: ['[[', ']]'],
        el: "#app",

        data: {
            config: {
                headers:{
                    "X-CSRFToken": getCookie('csrftoken')
                }
            },

            departmentSelect: [{

            }],

            selectedDepartment: '',

            projectSelect: null,

            selectedProject: '',

            projectPlan: {
                name: null,
                dateStart: null,
                dateEnd: null,
                dateCreated: null,
                dateCompleted: null,
                projectLeader: {
                    first_name: null,
                    last_name: null,
                },
                department: null,
                accentColor: "#D9177F",
                projectstage: [{
                    name: null,
                    accentColor: "#D9177F",
                    projecttask: [{
                        name: null,
                        datetimeStart: null,
                        datetimeEnd: null,
                        notes: null,
                        movetostage: '',
                        projectassignee: [{
                            user: {
                                first_name: null,
                                last_name: null,
                            }
                        }]
                    }]
                }]
            },

            addDepartment: {
                name: null,
            },

            addProject: {
                name: null,
                dateStart: null,
                dateEnd: null,
                projectLeader: '', //ID
                department: '', //ID
                accentColor: "#D9177F",
            },

            addStage: {
                name: null,
                accentColor: "#D9177F",
                project: ''
            },

            assigneeSelect: [{
                first_name: null,
                last_name: null,
                id: null,
            }],

            addTask: {
                name: null,
                datetimeStart: null,
                datetimeEnd: null,
                notes: null,
                assignees: [{
                    id: ''
                }],
                stage: null,
            },

            editStage: {
                name: null,
                accentColor: "#D9177F",
                project: null,
            },

            editTask: {
                name: null,
                datetimeStart: null,
                datetimeEnd: null,
                notes: null,
                assignees: [{
                    id: '',
                }],
                stage: null
            },

            editDepartment: {
                name: null,
            },

            editProject: {
                name: null,
                dateStart: null,
                dateEnd: null,
                projectLeader: '', //ID
                department: '', //ID
                accentColor: "#D9177F",
            }
        },

        methods: {
            async onLoad(){
                await axios.get("/api/project-department/filterByBranch/")
                .then(res=>this.departmentSelect = res.data)
    
                await axios.get('/api/assignee/filterByBranch/')
                .then(res=>this.assigneeSelect = res.data)  
            },
            getSelectedDepartment(id){
                if(this.projectPlan.name){
                    return this.departmentSelect.find((i)=>{
                        return i.id == id
                    }).name
                }
            },

            fetchProjectSelect(){
                this.projectSelect = this.departmentSelect.find((i)=>{
                    return i.id == this.selectedDepartment
                }).projectplan

                this.projectPlan = {
                    name: null,
                    dateStart: null,
                    dateEnd: null,
                    dateCreated: null,
                    dateCompleted: null,
                    projectLeader: {
                        first_name: null,
                        last_name: null,
                    },
                    department: null,
                    accentColor: "#D9177F",
                    projectstage: [{
                        name: null,
                        accentColor: "#D9177F",
                        projecttask: [{
                            name: null,
                            datetimeStart: null,
                            datetimeEnd: null,
                            notes: null,
                            projectassignee: [{
                                user: {
                                    first_name: null,
                                    last_name: null,
                                }
                            }]
                        }]
                    }]
                }
            },

            fetchProjectPlan(id){
                axios.get(`/api/project-plan-nested/${id}/`)
                .then(res=>this.projectPlan = res.data)
            },

            formatDateTime1(value){
                const months = [
                    'Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sep',
                    'Oct',
                    'Nov',
                    'Dec'
                ]

                const days = [
                    'Sun',
                    'Mon',
                    'Tue',
                    'Wed',
                    'Thu',
                    'Fri',
                    'Sat'
                ]

                value = new Date(value)
                year = value.getFullYear()
                month = months[value.getMonth()]
                date = value.getDate()
                hour = (value.getHours() + 24) % 12 || 12; 
                minute = (value.getMinutes()<10?'0':'') + value.getMinutes()
                day = days[value.getDay()]
                meridian = value.getHours() >= 12 ? 'pm' : 'am'
                formatted = `${month}. ${date}, ${year} - ${hour}:${minute} ${meridian}`

                return formatted
            },

            formatDateTime2(value){
                const months = [
                    'Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sep',
                    'Oct',
                    'Nov',
                    'Dec'
                ]

                const days = [
                    'Sun',
                    'Mon',
                    'Tue',
                    'Wed',
                    'Thu',
                    'Fri',
                    'Sat'
                ]

                value = new Date(value)
                year = value.getFullYear()
                month = months[value.getMonth()]
                date = value.getDate()
                hour = (value.getHours() + 24) % 12 || 12; 
                minute = (value.getMinutes()<10?'0':'') + value.getMinutes()
                day = days[value.getDay()]
                meridian = value.getHours() >= 12 ? 'pm' : 'am'
                formatted = `${month}. ${date} - ${hour}:${minute} ${meridian}`

                return formatted
            },

            formatDate2(value){
                const months = [
                    'Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sep',
                    'Oct',
                    'Nov',
                    'Dec'
                ]

                value = new Date(value)
                year = value.getFullYear()
                month = months[value.getMonth()]
                date = value.getDate()
                formatted = `${month}. ${date}`

                return formatted
            },

            formatDate1(value){
                const months = [
                    'Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sep',
                    'Oct',
                    'Nov',
                    'Dec'
                ]

                value = new Date(value)
                year = value.getFullYear()
                month = months[value.getMonth()]
                date = value.getDate()
                formatted = `${month}. ${date}, ${year}`

                return formatted
            },

            pushTask(){
                this.addTask.assignees.push({
                    id: '',
                })
            },

            popTask(){
                this.addTask.assignees.pop()
            },

            pushEditTask(){
                this.editTask.assignees.push({
                    id: '',
                })
            },

            popEditTask(){
                this.editTask.assignees.pop()
            },

            resetDepartmentSelect(){
                this.departmentSelect = [{

                }]
            },

            resetSelectedDepartment(){
                this.selectedDepartment = ''
            },

            resetProjectSelect(){
                this.projectSelect = null
            },

            resetSelectedProject(){
                this.selectedProject = ''
            },

            resetProjectPlan(){
                this.projectPlan = {
                    name: null,
                    dateStart: null,
                    dateEnd: null,
                    dateCreated: null,
                    dateCompleted: null,
                    projectLeader: {
                        first_name: null,
                        last_name: null,
                    },
                    department: null,
                    accentColor: "#D9177F",
                    projectstage: [{
                        name: null,
                        accentColor: "#D9177F",
                        projecttask: [{
                            name: null,
                            datetimeStart: null,
                            datetimeEnd: null,
                            notes: null,
                            projectassignee: [{
                                user: {
                                    first_name: null,
                                    last_name: null,
                                }
                            }]
                        }]
                    }]
                }
            },

            resetAddDepartment(){
                this.addDepartment = {
                    name: null,
                }
            },

            resetAddProject(){
                this.addProject = {
                    name: null,
                    dateStart: null,
                    dateEnd: null,
                    projectLeader: '', //ID
                    department: '', //ID
                    accentColor: "#D9177F",
                }
            },

            resetAddStage(){
                this.addStage = {
                    name: null,
                    accentColor: "#D9177F",
                    project: ''
                }
            },

            resetAssigneeSelect(){
                this.assigneeSelect = [{
                    first_name: null,
                    last_name: null,
                    id: null,
                }]
            },

            resetAddTask(){
                this.addTask = {
                    name: null,
                    datetimeStart: null,
                    datetimeEnd: null,
                    notes: null,
                    assignees: [{
                        id: ''
                    }],
                    stage: null,
                }
            },

            resetEditStage(){
                this.editStage = {
                    name: null,
                    accentColor: "#D9177F",
                    project: null,
                }
            },

            resetEditTask(){
                this.editTask = {
                    name: null,
                    datetimeStart: null,
                    datetimeEnd: null,
                    notes: null,
                    assignees: [{
                        id: '',
                    }],
                    stage: null
                }
            },

            resetEditDepartment(){
                this.editDepartment = {
                    name: null,
                }
            },

            resetEditProject(){
                this.editProject = {
                    name: null,
                    dateStart: null,
                    dateEnd: null,
                    projectLeader: '', //ID
                    department: '', //ID
                    accentColor: "#D9177F",
                }
            },

            submitAddDepartment(){
                message = "Adding Deparment"
                Swal.fire({
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    html: `<div class="spinner-grow text-warning" role="status"></div> <div class="spinner-grow text-warning delay-1" role="status"></div> <div class="spinner-grow text-warning delay-2" role="status"></div> <br><br> <span class="font-bold font-size-18">${message} . . .</span> <br> <span class="font-size-12 gray font-medium">Press F12 to check if something went wrong.</span>`
                })
                axios.post('/pps-add-department/', this.addDepartment, this.config)
                .then(res=>{
                    Swal.close()
                    if(res.data == 0){
                        this.onLoad()
                        this.resetAddDepartment()
                        $('#addDepartmentModal').modal('hide')
                        Swal.fire({
                            title: 'Success!',
                            icon: 'success'
                        })
                    }
                })
                .catch(err=>{
                    Swal.close()
                    Swal.fire({
                        title: 'Something went wrong.',
                        icon: 'error',
                        html: err.message
                    })
                })
            },

            submitAddProject(){
                message = "Adding Deparment"
                Swal.fire({
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    html: `<div class="spinner-grow text-warning" role="status"></div> <div class="spinner-grow text-warning delay-1" role="status"></div> <div class="spinner-grow text-warning delay-2" role="status"></div> <br><br> <span class="font-bold font-size-18">${message} . . .</span> <br> <span class="font-size-12 gray font-medium">Press F12 to check if something went wrong.</span>`
                })

                axios.post('/pps-add-project/', this.addProject, this.config)
                .then(res=>{
                    Swal.close()
                    if(res.data == 0){
                        this.onLoad()
                        .then(res=>{
                            try {
                                this.fetchProjectSelect()
                            }
                            catch(err){
                                console.log(err.message)
                            }
                        })
                        $("#addProjectModal").modal('hide')
                        this.resetAddProject()
                        
                        Swal.fire({
                            title: 'Success!',
                            icon: 'success'
                        })
                    }
                })
                .catch(err=>{
                    Swal.close()
                    Swal.fire({
                        title: 'Something went wrong.',
                        icon: 'error',
                        html: err.message
                    })
                })
            },

            initAddStage(){
                this.addStage.project = this.projectPlan.id
            },

            submitAddStage(){
                message = "Adding Stage"
                Swal.fire({
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    html: `<div class="spinner-grow text-warning" role="status"></div> <div class="spinner-grow text-warning delay-1" role="status"></div> <div class="spinner-grow text-warning delay-2" role="status"></div> <br><br> <span class="font-bold font-size-18">${message} . . .</span> <br> <span class="font-size-12 gray font-medium">Press F12 to check if something went wrong.</span>`
                })
                axios.post('/pps-add-stage/', this.addStage, this.config)
                .then(res=>{
                    Swal.close()
                    if(res.data == 0){
                        this.onLoad()
                        .then(res=>{
                            this.fetchProjectPlan(this.projectPlan.id)
                        })
                        $("#addStageModal").modal('hide')
                        this.resetAddStage()

                        Swal.fire({
                            title: 'Success!',
                            icon: 'success'
                        })
                    }
                })
                .catch(err=>{
                    Swal.close()
                    Swal.fire({
                        title: 'Something went wrong.',
                        icon: 'error',
                        html: err.message
                    })
                })
            },

            initAddTask(id){
                this.addTask.stage = id
            },
            
            submitAddTask(){
                message = "Adding Task"
                Swal.fire({
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    html: `<div class="spinner-grow text-warning" role="status"></div> <div class="spinner-grow text-warning delay-1" role="status"></div> <div class="spinner-grow text-warning delay-2" role="status"></div> <br><br> <span class="font-bold font-size-18">${message} . . .</span> <br> <span class="font-size-12 gray font-medium">Press F12 to check if something went wrong.</span>`
                })
                axios.post('/pps-add-task/', this.addTask, this.config)
                .then(res=>{
                    Swal.close()
                    if(res.data == 0){
                        this.onLoad()
                        .then(res=>{
                            this.fetchProjectPlan(this.projectPlan.id)
                            $("#addTaskModal").modal('hide')
                            this.resetAddTask()

                            Swal.fire({
                                title: 'Success!',
                                icon: 'success'
                            })
                        })
                    }
                })
                .catch(err=>{
                    Swal.close()
                    Swal.fire({
                        title: 'Something went wrong.',
                        icon: 'error',
                        html: err.message
                    })
                })
            },

            initEditStage(id){
                var s = this.projectPlan.projectstage.find((i)=>{
                    return i.id == id
                })
                this.editStage.id = s.id
                this.editStage.name = s.name
                this.editStage.accentColor = s.accentColor
                this.editStage.project = s.projectPlan
            },

            submitEditStage(){
                message = "Saving Changes"
                Swal.fire({
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    html: `<div class="spinner-grow text-warning" role="status"></div> <div class="spinner-grow text-warning delay-1" role="status"></div> <div class="spinner-grow text-warning delay-2" role="status"></div> <br><br> <span class="font-bold font-size-18">${message} . . .</span> <br> <span class="font-size-12 gray font-medium">Press F12 to check if something went wrong.</span>`
                })

                axios.post('/pps-save-edit-stage/', this.editStage, this.config)
                .then(res=>{
                    Swal.close()
                    if(res.data == 0){
                        this.onLoad()
                        .then(res=>{
                            this.fetchProjectPlan(this.projectPlan.id)
                        })
                        $("#editStageModal").modal('hide')
                        this.resetEditStage()

                        Swal.fire({
                            title: 'Success!',
                            icon: 'success'
                        })
                    }
                })
                .catch(err=>{
                    Swal.close()
                    Swal.fire({
                        title: 'Something went wrong.',
                        icon: 'error',
                        html: err.message
                    })
                })
            },

            deleteEditStage(){
                Swal.fire({
                    title: "Are you sure?",
                    icon: "warning",
                    html: "Are you sure you want to delete this stage? This action cannot be undone.",
                    showConfirmButton: true,
                    confirmButtonText: 'I am sure.',
                    showCancelButton: true,
                })
                .then(result=>{
                    if(result.isConfirmed){
                        message = "Deleting Stage"
                        Swal.fire({
                            showConfirmButton: false,
                            allowOutsideClick: false,
                            html: `<div class="spinner-grow text-warning" role="status"></div> <div class="spinner-grow text-warning delay-1" role="status"></div> <div class="spinner-grow text-warning delay-2" role="status"></div> <br><br> <span class="font-bold font-size-18">${message} . . .</span> <br> <span class="font-size-12 gray font-medium">Press F12 to check if something went wrong.</span>`
                        })
                        axios.post('/pps-delete-stage/', this.editStage, this.config)
                        .then(res=>{
                            Swal.close()
                            if(res.data == 0){
                                this.onLoad()
                                .then(res=>{
                                    this.fetchProjectPlan(this.projectPlan.id)
                                })
                                $("#editStageModal").modal('hide')
                                this.resetEditStage()
        
                                Swal.fire({
                                    title: 'Success!',
                                    icon: 'success'
                                })
                            }
                        })
                    }
                })
                .catch(err=>{
                    Swal.close()
                    Swal.fire({
                        title: 'Something went wrong.',
                        icon: 'error',
                        html: err.message
                    })
                })
            },

            initEditTask(sID, tID){
                var s = this.projectPlan.projectstage.find((i)=>{
                    return i.id == sID
                })

                var t = s.projecttask.find(i=>{
                    return i.id == tID
                })

                this.editTask.name = t.name
                this.editTask.id = t.id
                this.editTask.datetimeStart = t.datetimeStart
                this.editTask.datetimeEnd = t.datetimeEnd
                this.editTask.notes = t.notes
                this.editTask.assignees = t.projectassignee.map(el=>{
                    return el.user
                })
            },

            submitEditTask(){
                message = "Saving Changes"
                Swal.fire({
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    html: `<div class="spinner-grow text-warning" role="status"></div> <div class="spinner-grow text-warning delay-1" role="status"></div> <div class="spinner-grow text-warning delay-2" role="status"></div> <br><br> <span class="font-bold font-size-18">${message} . . .</span> <br> <span class="font-size-12 gray font-medium">Press F12 to check if something went wrong.</span>`
                })

                axios.post('/pps-save-edit-task/', this.editTask, this.config)
                .then(res=>{
                    Swal.close()
                    if(res.data == 0){
                        this.onLoad()
                        .then(res=>{
                            this.fetchProjectPlan(this.projectPlan.id)
                            $("#editTaskModal").modal('hide')
                            this.resetEditTask()

                            Swal.fire({
                                title: 'Success!',
                                icon: 'success'
                            })
                        })
                    }
                })
                .catch(err=>{
                    Swal.close()
                    Swal.fire({
                        title: 'Something went wrong.',
                        icon: 'error',
                        html: err.message
                    })
                })
            },

            deleteEditTask(){
                Swal.fire({
                    title: "Are you sure?",
                    icon: "warning",
                    html: "Are you sure you want to delete this task? This action cannot be undone.",
                    showConfirmButton: true,
                    confirmButtonText: 'I am sure.',
                    showCancelButton: true,
                })
                .then(result=>{
                    if(result.isConfirmed){
                        message = "Deleting Task"
                        Swal.fire({
                            showConfirmButton: false,
                            allowOutsideClick: false,
                            html: `<div class="spinner-grow text-warning" role="status"></div> <div class="spinner-grow text-warning delay-1" role="status"></div> <div class="spinner-grow text-warning delay-2" role="status"></div> <br><br> <span class="font-bold font-size-18">${message} . . .</span> <br> <span class="font-size-12 gray font-medium">Press F12 to check if something went wrong.</span>`
                        })
                        axios.post('/pps-delete-task/', this.editTask, this.config)
                        .then(res=>{
                            Swal.close()
                            if(res.data == 0){
                                this.onLoad()
                                .then(res=>{
                                    this.fetchProjectPlan(this.projectPlan.id)
                                })
                                $("#editTaskModal").modal('hide')
                                this.resetEditTask()
                                Swal.fire({
                                    title: 'Success!',
                                    icon: 'success'
                                })
                            }
                        })
                    }
                })
                .catch(err=>{
                    Swal.close()
                    Swal.fire({
                        title: 'Something went wrong.',
                        icon: 'error',
                        html: err.message
                    })
                })
            },

            initEditDepartment(id){
                this.editDepartment.name = this.departmentSelect.find(i=>{
                    return i.id == id
                }).name

                this.editDepartment.id = id
            },

            submitEditDepartment(){
                message = "Saving Changes"
                Swal.fire({
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    html: `<div class="spinner-grow text-warning" role="status"></div> <div class="spinner-grow text-warning delay-1" role="status"></div> <div class="spinner-grow text-warning delay-2" role="status"></div> <br><br> <span class="font-bold font-size-18">${message} . . .</span> <br> <span class="font-size-12 gray font-medium">Press F12 to check if something went wrong.</span>`
                })

                axios.post('/pps-save-edit-department/', this.editDepartment, this.config)
                .then(res=>{
                    if(res.data == 0){
                        this.onLoad()
                        this.resetEditDepartment()
                        $("#editDepartmentModal").modal("hide")
                        Swal.fire({
                            title: 'Success!',
                            icon: 'success'
                        })
                    }
                })
                .catch(err=>{
                    Swal.close()
                    Swal.fire({
                        title: 'Something went wrong.',
                        icon: 'error',
                        html: err.message
                    })
                })
            },

            initEditProject(){
                this.editProject.name = this.projectPlan.name
                this.editProject.dateStart = this.projectPlan.dateStart
                this.editProject.dateEnd = this.projectPlan.dateEnd
                this.editProject.projectLeader = this.projectPlan.projectLeader.id
                this.editProject.department = this.projectPlan.department
                this.editProject.accentColor = this.projectPlan.accentColor
                this.editProject.id = this.projectPlan.id
            },

            submitEditProject(){
                message = "Saving Changes"
                Swal.fire({
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    html: `<div class="spinner-grow text-warning" role="status"></div> <div class="spinner-grow text-warning delay-1" role="status"></div> <div class="spinner-grow text-warning delay-2" role="status"></div> <br><br> <span class="font-bold font-size-18">${message} . . .</span> <br> <span class="font-size-12 gray font-medium">Press F12 to check if something went wrong.</span>`
                })

                axios.post('/pps-save-edit-project/', this.editProject, this.config)
                .then(res=>{
                    Swal.close()
                    if(res.data == 0){
                        this.onLoad()
                        .then(res=>{
                            try {
                                this.fetchProjectSelect()
                            }
                            catch(err){
                                console.log(err.message)
                            }
                        })
                        $("#editProjectModal").modal('hide')
                        this.resetEditProject()
                        
                        Swal.fire({
                            title: 'Success!',
                            icon: 'success'
                        })
                    }
                })
                .catch(err=>{
                    Swal.close()
                    Swal.fire({
                        title: 'Something went wrong.',
                        icon: 'error',
                        html: err.message
                    })
                })
            },

            deleteEditProject(){
                Swal.fire({
                    title: "Are you sure?",
                    icon: "warning",
                    html: "Are you sure you want to delete this project? This action cannot be undone.",
                    showConfirmButton: true,
                    confirmButtonText: 'I am sure.',
                    showCancelButton: true,
                })
                .then(result=>{
                    if(result.isConfirmed){
                        message = "Deleting Project"
                        Swal.fire({
                            showConfirmButton: false,
                            allowOutsideClick: false,
                            html: `<div class="spinner-grow text-warning" role="status"></div> <div class="spinner-grow text-warning delay-1" role="status"></div> <div class="spinner-grow text-warning delay-2" role="status"></div> <br><br> <span class="font-bold font-size-18">${message} . . .</span> <br> <span class="font-size-12 gray font-medium">Press F12 to check if something went wrong.</span>`
                        })
                        axios.post('/pps-delete-project/', this.editProject, this.config)
                        .then(res=>{
                            Swal.close()
                            if(res.data == 0){
                                this.onLoad()
                                this.resetProjectPlan()
                                this.resetProjectSelect()
                                $("#editProjectModal").modal('hide')
                                this.resetEditProject()
        
                                Swal.fire({
                                    title: 'Success!',
                                    icon: 'success'
                                })
                            }
                        })
                    }
                })
            },

            moveTaskToStage(taskID, stageID){
                axios.post('/move-task-to-stage/', {taskID: taskID, stageID: stageID}, this.config)
                .then(res=>{
                    if(res.data==0){
                        this.onLoad()
                        .then(res=>{
                            this.fetchProjectPlan(this.projectPlan.id)
                        })
                    }
                })
                .catch(err=>{
                    Swal.fire({
                        title: "Something went wrong.",
                        icon: 'error',
                        html: err.message
                    })
                })
            }
        },

        mounted(){
            this.onLoad()
        }
    })
</script>

{% endblock %}